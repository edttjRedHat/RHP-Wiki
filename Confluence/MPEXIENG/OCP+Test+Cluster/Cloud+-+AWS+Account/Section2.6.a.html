---
---
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <script type="module" src="../../../../Scripts/js/global.js"></script>
</head>
<body>
<script type="module" src="{{site.baseURL}}{{site.mainPath}}/Scripts/js/global.js"></script>
<div style="font-family:monospace;font-size:large;max-height:40em;line-height:normal;overflow:auto;white-space:nowrap;">
    <div style="float:left;min-width:100%;" tabindex="0">
<pre style="font-size:medium;">
__SHELL=0 \
    _BW__NOTE_NAME='note.AWS--IAMuser--OCPinstaller' \
    KUBECONFIG="${KUBECONFIG:-${HOME}/.kube/config}" \
    BW_SESSION="$((bw status | grep -q '"status":"unlocked"') &amp;&amp; echo "${BW_SESSION}" || bw unlock --raw || bw login --raw)" \
    AWS_REGION=us-east-1 \
    AWS_ACCOUNT_ID=624914081466 \
    AWS_CONFIG_FILE="${HOME}/.aws/config" \
    AWS_SHARED_CREDENTIALS_FILE="${HOME}/.aws/credentials" \
    bash -ec "$(cat - 0&lt;&lt;'cmdEOF'
        [ -n "${BW_SESSION}" ] &amp;&amp; bw sync || {
            echo 'You do NOT have an active and sync:ed BitWarden Session!!!'
            exit 1
        }
        ((__SHELL)) &amp;&amp; exec bash    # Do NOT forget to exit the interactive session!!!

        typeset e= iamIP= iamRN=

        eval "$(
            bw get notes "${_BW__NOTE_NAME}" || {
                echo "You may NOT have access to BitWarden Note \`${_BW__NOTE_NAME}\`." 1&gt;&amp;2
                echo false
            }
        )"
        aws configure list
        aws sts get-caller-identity

        # Adding IAM Permission Policy `AmazonSSMManagedInstanceCore` to the EC2 Instance IAM Role to allow connecting to the VM via SSM.
        for e in $(oc get nodes -o jsonpath='{range .items[*]}{.spec.providerID}{"\n"}{end}'); do
            iamIP="$(aws ec2 describe-instances --instance-ids "${e##*/}" --query 'Reservations[0].Instances[0].IamInstanceProfile.Arn' --output text)"
            iamRN="$(aws iam get-instance-profile --instance-profile-name "${iamIP##*/}" --query 'InstanceProfile.Roles[0].RoleName' --output text)"
#           aws iam list-role-policies --role-name "${iamRN}" --query 'PolicyNames[]' --output text # Inline Policy.
            {   # Attached Policy.
                aws iam list-attached-role-policies --role-name "${iamRN}" --query 'AttachedPolicies[].PolicyName' --output text |
                grep -qE '^AmazonSSMManagedInstanceCore$'
            } || aws iam attach-role-policy --role-name "${iamRN}" --policy-arn 'arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore'
        done

        for e in {master,worker}; do
            oc apply -f - 0&lt;&lt;ocEOF
apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
    name: 99999-00--${e}--ssm-agent-install
    labels:
        machineconfiguration.openshift.io/role: ${e}
spec:
    config:
        ignition:
            version: $(oc get MachineConfigs -o jsonpath='{range .items[*]}{.spec.config.ignition.version}{"\n"}{end}' | grep -vE '^\$' | head -n 1)
        storage: {} # Required empty object
        systemd:
            units:
              - name: aws-ec2--ssm-agent--install.service
                enabled: true
                contents: |
                    [Unit]
                    Description=Install AWS EC2 SSM Agent
                    After=network-online.target
                    Wants=network-online.target

                    [Service]
                    Type=oneshot
                    RemainAfterExit=yes
                    ExecStart=/usr/bin/sh -c ' \\
                        # Determine the correct the architecture string. \\
                        typeset arch="\$\$(/usr/bin/uname -m)"; \\
                        case \$\${arch} in \\
                          (x86_64)  arch=amd64;; \\
                          (aarch64) arch=arm64;; \\
                        esac; \\
                        if /usr/bin/rpm -q amazon-ssm-agent; then \\
                            /usr/bin/systemctl enable amazon-ssm-agent.service; \\
                            /usr/bin/systemctl start amazon-ssm-agent.service; \\
                        else \\
                            # Remove any broken stub agent if present, ignore if not found. \\
                            /usr/bin/rpm-ostree override remove amazon-ssm-agent || true; \\
                            # Install the agent. \\
                            /usr/bin/rpm-ostree install "https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/linux_\$\${arch}/amazon-ssm-agent.rpm"; \\
                            /usr/bin/systemctl reboot; \\
                        fi; \\
                    '

                    [Install]
                    WantedBy=multi-user.target
ocEOF
        done
cmdEOF
    )"
</pre>
    </div>
</div>
<hr style="border:1px solid black;"/>
<div style="font-family:monospace;font-size:large;max-height:20em;line-height:normal;overflow:auto;white-space:nowrap;">
    <div style="float:left;min-width:100%;" tabindex="0">
<pre style="font-size:medium;color:black;background-color:cyan;">
? Master password: <span style="color:red;font-weight:bold;">[hidden]</span>
Syncing complete.
      Name                    Value             Type    Location
      ----                    -----             ----    --------
   profile                &lt;not set&gt;             None    None
access_key     ****************FYL3              env
secret_key     ****************tAq9              env
    region                us-east-1              env    ['AWS_REGION', 'AWS_DEFAULT_REGION']
{
    "UserId": "AIDAZC76IE25KXVQUCR6W",
    "Account": "624914081466",
    "Arn": "arn:aws:iam::624914081466:user/u-ieng--ocp-installer"
}
machineconfig.machineconfiguration.openshift.io/99999-00--master--ssm-agent-install created
machineconfig.machineconfiguration.openshift.io/99999-00--worker--ssm-agent-install created
</pre>
    </div>
</div>
<hr style="border:3px solid black;"/>
<div style="font-family:monospace;font-size:large;max-height:40em;line-height:normal;overflow:auto;white-space:nowrap;">
    <div style="float:left;min-width:100%;" tabindex="0">
<pre style="font-size:medium;">
# Monitor the MCP Deployment.
(
    function CheckMCPstatus () {
        typeset poolName="${1}"; (($#)) &amp;&amp; shift
        typeset poolSign="${1}"; (($#)) &amp;&amp; shift
        typeset mcpAction= mcpType= mcpCurState=
        typeset -i i=2 s=0

        while ((i--)); do
            case ${i} in
              (1)   mcpAction=start     mcpType=Updated     ;;
              (0)   mcpAction=finish    mcpType=Updating    ;;
            esac

            echo -n $'\n'"Waiting for MCP ${poolName} pool to ${mcpAction} updating${poolSign}${poolSign}${poolSign}"
            while true; do
                while true; do
                    read -rt 5 mcpCurState; s=$?
                    if {
                        ((s &gt; 128)) ||
                        { ((! s)) &amp;&amp; [ "${mcpCurState}" != False ]; }

                    }; then
                        echo -n "${poolSign}"
                    else
                        kill $! 2&gt; /dev/null
                        ((s)) &amp;&amp; break || break 2
                    fi
                done 0&lt; &lt;(
                    oc get "MachineConfigPools/${poolName}" \
                        -o jsonpath='{.status.conditions[?(@.type=="'"${mcpType}"'")].status}{"\n"}' --watch
                )
            done
        done
        echo
    }

    CheckMCPstatus worker ':' &amp;
    sleep 3
    CheckMCPstatus master '.'
    wait

    oc get MachineConfigPools
)
</pre>
    </div>
</div>
<hr style="border:1px solid black;"/>
<div style="font-family:monospace;font-size:large;max-height:20em;line-height:normal;overflow:auto;white-space:nowrap;">
    <div style="float:left;min-width:100%;" tabindex="0">
<pre style="font-size:medium;color:black;background-color:cyan;">
Waiting for MCP worker pool to start updating:::
Waiting for MCP worker pool to finish updating::::
Waiting for MCP master pool to start updating...
Waiting for MCP master pool to finish updating....:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.::.::.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:..:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:..:.:.::.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.:.::.:
.............................................................................................................
NAME     CONFIG                                             UPDATED   UPDATING   DEGRADED   MACHINECOUNT   READYMACHINECOUNT   UPDATEDMACHINECOUNT   DEGRADEDMACHINECOUNT   AGE
master   rendered-master-cdf02353950debc6453cdaab371cd2bd   True      False      False      3              3                   3                     0                      45h
worker   rendered-worker-5d56a47ed76566546619fd571c9bc1d0   True      False      False      3              3                   3                     0                      45h
</pre>
    </div>
</div>
</body>
</html>
